!function(t){"function"==typeof define&&define.amd?define(["jquery"],t):t(jQuery)}(function(t){"use strict";var e=window.FormData,i=function(e,i){this.options=i,this.$el=t(e),this.id=this.$el.attr("id"),this.disabled=!1,this.init()};i.VALID_SELECTOR="input:not([type='submit'], [type='reset']),textarea,select",i.DEFAULTS={url:null,type:"post",realTime:!1,isPassed:!0,sync:!1,submitBtn:null,novalidate:!0,placement:"right",dataType:"json",toJsonString:!0,beforeSubmit:function(){},beforeSend:function(){},done:function(){},fail:function(){},always:function(){},validate:function(){return!0}};var n={email:"^([a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+(.[a-zA-Z0-9_-])+",phone:"^1[3|4|5|7|8][0-9]\\d{8}$",birthday:"^(19|20)\\d{2}-(1[0-2]|0?[1-9])-(0?[1-9]|[1-2][0-9]|3[0-1])$",tel:"^0(10|2[0-5789]|\\d{3})-\\d{7,8}$",idcard:"((11|12|13|14|15|21|22|23|31|32|33|34|35|36|37|41|42|43|44|45|46|50|51|52|53|54|61|62|63|64|65|71|81|82|91)\\d{4})((((19|20)(([02468][048])|([13579][26]))0229))|((20[0-9][0-9])|(19[0-9][0-9]))((((0[1-9])|(1[0-2]))((0[1-9])|(1\\d)|(2[0-8])))|((((0[1,3-9])|(1[0-2]))(29|30))|(((0[13578])|(1[02]))31))))((\\d{3}(x|X))|(\\d{4}))",int:"^[0-9]\\d*$",gender:"^['男'|'女']$",password:"^[\\w]{5,18}$",username:"^[a-zA-z]\\w{5,15}$",number:"^\\-?\\d+(\\.\\d+)?$",ip:"([0-9]{1,3}\\.{1}){3}[0-9]{1,3}",zipcode:"^[1-9]\\d{5}$",float:"^[+]?\\d+(\\.\\d+)?$",money:"(^[1-9]\\d{0,9}(\\.\\d{1,2})?$)",chinese:"[\\u4E00-\\u9FA5\\uF900-\\uFA2D]",url:"^(http|https|ftp)\\:\\/\\/[a-z0-9\\-\\.]+\\.[a-z]{2,3}(:[a-z0-9]*)?\\/?([a-z0-9\\-\\._\\?\\,\\'\\/\\\\\\+&amp;%\\$#\\=~])*$",domain:"^[a-zA-Z0-9][a-zA-Z0-9-]{0,61}[a-zA-Z0-9](?:\\.[a-zA-Z]{2,})+$"};i.LOCALES=[],i.LOCALES["zh-CN"]=i.LOCALES.cn={},t.extend(i.DEFAULTS,i.LOCALES["zh-CN"]),i.prototype.init=function(){this.options.novalidate&&this.$el.attr("novalidate","novalidate"),this.options.isPassed=!0,this.options.url||(this.options.url=this.$el.prop("action"));var e=this.$el.attr("method")||this.$el.prop("method");this.options.type||(this.options.type=e);var i=this.$el.data("placement");i&&(this.options.placement=i),this.initValid(),this.options.submitBtn?t(this.options.submitBtn).off("click").on("click",t.proxy(this.submit,this)):this.$el.off("submit").on("submit",t.proxy(this.submit,this))},i.prototype.initValid=function(){var e=this;this.options.realTime&&this.$el.find(i.VALID_SELECTOR).each(function(){var i=t(this);i&&i.blur(function(){e.validOne(i)})})},i.prototype.submit=function(i){var n=this;i.preventDefault();var o=this.validAll(),s=n.options.validate();if(o&&s){var r;if(this.disabled)return void i.preventDefault();if(this.disabled=!0,this.options.sync)this.$el.off("submit").submit();else{if(!this.options.url)throw new Error("Can't find submit url.");if(r=t.extend({},this.options,{type:n.options.type,beforeSend:t.proxy(n.beforeSend,this)}),e&&"multipart/form-data"===this.$el.attr("enctype")){var a=new e(this.$el[0]);this.options.beforeSubmit(a),r.data=a,r.processData=!1,r.contentType=!1}else{var u=this.serialize();this.options.beforeSubmit(u),this.options.toJsonString?(r.data=JSON.stringify(u),r.contentType="application/json"):(r.data=u,r.dataType="json")}t.ajax(r).done(function(t){n.success(t)}).fail(function(){n.error()}).always(function(){n.complete()})}}},i.prototype.serialize=function(){var e=this,i=e.$el.serializeArray(),n={};return t(i).each(function(){if(n[this.name])n[this.name].push(this.value);else{var t=e.$el.find("[name='"+this.name+"']")[0],i=(t.type||t.nodeName).toLowerCase();n[this.name]=/^(select-multiple|checkbox)$/i.test(i)?[this.value]:this.value}}),n},i.prototype.beforeSend=function(e,i){this.$el.find(":submit").prop("disabled",!0);var n=this.options;t.isFunction(n.beforeSend)&&n.beforeSend(e,i)},i.prototype.success=function(e){var i=this.options;t.isFunction(i.done)&&i.done(e)},i.prototype.error=function(){var e=this.options;t.isFunction(e.fail)&&e.fail()},i.prototype.complete=function(){var e=this.options;this.disabled=!1,this.$el.find(":submit").prop("disabled",!1),t.isFunction(e.always)&&e.always()},i.prototype.getRule=function(t){switch(t){case"int":return n.int;case"number":return n.number;case"email":return n.email;case"phone":return n.phone;case"username":return n.username;case"password":return n.password;case"idcard":return n.idcard;case"ip":return n.int;case"zipcode":return n.zipcode;case"url":return n.url;case"chinese":return n.chinese;case"money":return n.money;case"float":return n.float;case"gender":return n.gender;case"domain":return n.domain;default:return}},i.prototype.validAll=function(){var e=!0,n=this;return this.$el.find(i.VALID_SELECTOR).each(function(){var i=t(this);if(i&&(e=n.validOne(i),!e))return!1}),e},i.prototype.validOne=function(e){var i=!0,n=[],o=this,s=o.html5Attr(e,"type"),r=o.html5Attr(e,"title")||"格式不正确",a=o.html5Attr(e,"required")||void 0,u=t(e),p=u.val(),l=u[0].tagName.toLowerCase();if("input"==l&&s&&"radio"===s.toLowerCase()){var n=[],h=o.$el.find("input[type="+s.toLowerCase()+"]:checked");return a&&0==h.length&&n.push(r),o.handleError(n,e)}if("input"==l&&s&&"checkbox"===s.toLowerCase()){var n=[],d=parseInt(u.data("maxlength")),c=parseInt(u.data("minlength")),h=o.$el.find("input[type="+s.toLowerCase()+"]:checked"),f=h.length;return a&&0==f&&n.push(r),c&&!n.length&&h<f&&n.push("至少要选中 "+c+" 项！"),d&&!n.length&&h<f&&n.push("最多选中 "+d+" 项！"),o.handleError(n,e)}var m=this.html5Attr(e,"pattern")||function(){return s&&t.map(s.split("|"),function(t){var e=o.getRule(t);if(e)return e}).join("|")}();if("input"==l){var y,v=u.data("eq");if(a&&""==t.trim(p)&&n.push(r),!n.length&&m){var g=new RegExp(m);g.test(p)||n.push(r)}else if(!n.length&&v)p!==t(v).val()&&n.push(r);else if(!n.length&&p&&u.data("url")){var b=u.attr("name"),$=o.id+"-"+b+"-msg",S=o.id+"-"+b+"-val",A=o.id+"-"+p+"success",w="true"===sessionStorage.getItem(A),E=sessionStorage.getItem(S);w||E==p?w||n.push(sessionStorage.getItem(S)):y=t.get(u.data("url")+"/"+encodeURI(p)).done(function(t){t.success?(sessionStorage.setItem(S,void 0),sessionStorage.setItem($,void 0),sessionStorage.setItem(A,!0)):(n.push(t.message),sessionStorage.setItem(S,p),sessionStorage.setItem($,t.message),sessionStorage.setItem(A,!1))}).fail(function(){n.push("服务器出错误！"),sessionStorage.setItem(S,p),sessionStorage.setItem($,"服务器出错误！"),sessionStorage.setItem(A,!1)})}if(!y)return n.length||n.push.apply(n,o.isOverflow(e)),o.handleError(n,e);y.done(function(){return o.handleError(n,e)})}else{if("textarea"==l)return a?n.push(r):n.length||n.push.apply(n,o.isOverflow(e)),o.handleError(n,e);if("select"==l){if(a){var L=t.trim(p);0!=L&&""!=L&&void 0!=L||n.push(r)}return o.handleError(n,e)}}return i},i.prototype.handleError=function(e,i){return e.length?(this.showTip(i,e[0]),t(i).focusin(),!1):(this.destroyTip(i),!0)},i.prototype.isOverflow=function(e){var i,n,o,s=[],r=t(e),a=r.attr("min"),u=r.attr("max"),p=r.val();return a||u?(p=Number(p),i=Number(r.attr("step"))||1,a&&p<a?s.push("值必须大于或等于"+a):u&&p>u?s.push("值必须小于或等于"+u):i&&!/^\d+(\.0+)?$/.test((Math.abs(p-a||0)/i).toFixed(10))&&s.push("值无效")):(n=r.data("minlength"),o=r.data("maxlength"),n&&p.length<n?s.push("至少输入"+n+"个字符"):o&&p.length>o&&s.push("最多输入"+o+"个字符")),s},i.prototype.html5Attr=function(e,i){return t(e).attr(i)},i.prototype.showTip=function(e,i){var n=this,o={trigger:"manual",placement:n.options.placement};i&&(o.title=i),t(e).tooltip(o).tooltip("show")},i.prototype.destroyTip=function(e){t(e).tooltip("destroy")},i.prototype.destroy=function(){this.$el.removeData("smartForm")},i.prototype.clean=function(){this.$el.find(":input").not(":button,:submit,:reset").val("").removeAttr("checked").removeAttr("selected")};var o=["destroy","clean"];t.fn.smartForm=function(e){var n,s=Array.prototype.slice.call(arguments,1);return this.each(function(){var r=t(this),a=r.data("smartForm"),u=t.extend({},i.DEFAULTS,r.data(),"object"==typeof e&&e);if("string"==typeof e){if(t.inArray(e,o)<0)throw new Error("Method "+e+" does not exist on jQuery-smartForm");if(!a)return;n=a[e].apply(a,s)}a||r.data("smartForm",new i(this,u))}),"undefined"==typeof n?this:n},t.fn.smartForm.Constructor=i,t.fn.smartForm.defaults=i.DEFAULTS,t.fn.smartForm.methods=o,t.fn.tip=function(e){var i={trigger:"manual",placement:"right"},n=t.extend({},i);"string"==typeof e?n.title=e:t.extend(n,e),t(".tooltip-inner").css("background-color","red"),t(this).data(n).tooltip("show")},t(function(){t('[data-toggle="smartForm"]').smartForm()})});